<!DOCTYPE html>

<html>
<head>
  <title>PantaRhei.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>PantaRhei.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h2> </h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>	PantaRhei.js v <span class="number">0.1</span><span class="number">.3</span>
	
	(c) <span class="number">2012</span> Federico Weber
	distributed under the MIT license.
	federicoweber](http:<span class="regexp">//</span>federicoweber.com)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1>#</h1>
<p>save a reference to the global object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root = <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Define the top-level namespace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>PantaRhei = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>require underscore and backbone for testing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (exports?)
	PantaRhei = exports;
	_ = require <span class="string">'underscore'</span>
	Backbone = require <span class="string">'backbone'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>check for backbone existence in the browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> root.Backbone?
	Backbone = root.Backbone
	_ = root._</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>if backbone is missing throw an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> Backbone <span class="keyword">is</span> <span class="literal">undefined</span>
	<span class="keyword">throw</span> <span class="string">"Please import Backbone to use this library"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Nest top-level namespace into Backbone</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.PantaRhei = PantaRhei
VERSION = PantaRhei.VERSION = <span class="string">"0.1.3"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2>Flow</h2>
<p>The purpose of a <strong>Flow</strong> is to ease the declaration and execution 
of a chain of consecutive tasks. Like preparing the data for a new page.</p>
<p>The Flow will take care of extecuting the various
workers in the given order.</p>
<p>It is possible to directly pass to the constructor the queue
If the id is not provided it will generate an uniq one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Flow = <span class="class"><span class="keyword">class</span> <span class="title">PantaRhei</span>.<span class="title">Flow</span></span>
	constructor: (<span class="property">@id</span> = _.uniqueId(<span class="string">'flow_'</span>), <span class="property">@queue</span> = <span class="keyword">new</span> Array()) -&gt;
		<span class="property">@_currentWorker</span> = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>assign an uniq name ad id to the workers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="property">@_naming</span> worker <span class="keyword">for</span> worker <span class="keyword">in</span> <span class="property">@queue</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>return the Flow to enable cascade coding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>Methods</h3>
<h4>use</h4>
<p>This method is used to append a new worker in the queue 
it will throw an error if the worker is noth properly structured</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	use: (worker) -&gt;
		<span class="keyword">if</span> _.isFunction(worker.run) <span class="keyword">or</span> _.isFunction(worker)
			<span class="property">@_naming</span> worker
			<span class="property">@queue</span>.push worker
		<span class="keyword">else</span>
			<span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"Provide a proper worker"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>return the Flow to enable cascade coding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>This is the method used to actually run the flow
if the @shared object is not provided it create an empty one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	run: (<span class="property">@shared</span> = {}) -&gt;
		<span class="keyword">if</span> <span class="property">@queue</span>.length <span class="keyword">is</span> <span class="number">0</span>
			<span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"The workers queue is empty"</span>
		<span class="keyword">else</span>
			<span class="property">@_paused</span> = <span class="literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>create a running copy of the queue. This is usefull to allow multiple consecutive run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="property">@_runningQueue</span> = _.clone <span class="property">@queue</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>reverse the queueu to run everthing int the proper order</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="property">@_runningQueue</span>.reverse()</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>fire the run event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="property">@trigger</span>(<span class="string">'run'</span>, <span class="property">@shared</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>run the first worker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="property">@_next</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>return the Flow to enable cascade coding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h4>Pause</h4>
<p>Simply pause the flow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	pause: -&gt;
		<span class="property">@_paused</span> = <span class="literal">true</span>
		<span class="property">@trigger</span>(<span class="string">'pause'</span>, <span class="property">@shared</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>return the Flow to enable cascade coding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4>Resume</h4>
<p>Resume a paused Flow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	resume: -&gt;
		<span class="property">@_paused</span> = <span class="literal">false</span>
		<span class="property">@trigger</span>(<span class="string">'resume'</span>, <span class="property">@shared</span>)
		<span class="property">@_next</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>return the Flow to enable cascade coding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h4>Terminate</h4>
<p>This is used to interrupt the flow at will; it will empty the running queue and throw a <strong>terminate</strong> and a <strong>done</strong> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	terminate: -&gt;
		<span class="property">@_runningQueue</span> = []
		<span class="property">@trigger</span>(<span class="string">'terminate'</span>, <span class="property">@shared</span>)
		<span class="property">@_next</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>return the Flow to enable cascade coding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">return</span> <span class="keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>kill: -&gt;</p>
<pre><code># return the Flow to enable cascade coding
return this</code></pre>
<h4>_naming</h4>
<p>this is an internal function to an name and an id to the worker to ease debugging
the given name is equal to the worker id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_naming: (worker) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>add the id if it&#39;s not provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">unless</span> worker.id?
			<span class="keyword">if</span> !uniqId?
				uniqId = _.uniqueId(<span class="string">'worker_'</span>)
			worker.id = uniqId</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h4>_next</h4>
<p>this private method is used to actually run the worker 
it&#39;s also passed as the <strong>next</strong> callback to each worker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_next: (error) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>if an error is passed in fire the error event and pause the flow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="keyword">if</span> error
			<span class="property">@pause</span>()
			<span class="property">@trigger</span>(<span class="string">'error'</span>, error, <span class="property">@_currentWorker</span>.id)
		<span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>kill the previous worker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="keyword">if</span> <span class="property">@_currentWorker</span> <span class="keyword">and</span> _.isFunction <span class="property">@_currentWorker</span>.kill
				<span class="property">@_currentWorker</span>.kill()</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>run the worker queue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="keyword">if</span> <span class="property">@_runningQueue</span>.length &gt; <span class="number">0</span>
				<span class="property">@_currentWorker</span> = <span class="property">@_runningQueue</span>.pop()</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>run the worker if it provide the run method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="keyword">if</span> <span class="property">@_currentWorker</span> <span class="keyword">and</span> _.isFunction <span class="property">@_currentWorker</span>.run
					cNext = _.bind(<span class="property">@_next</span>, <span class="keyword">this</span>)
					<span class="property">@trigger</span>(<span class="string">'step'</span>, <span class="property">@shared</span>, <span class="property">@_currentWorker</span>)
					<span class="property">@_currentWorker</span>.run(<span class="property">@shared</span>, cNext)</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>run the worker if it&#39;s a function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@_currentWorker</span> <span class="keyword">and</span> _.isFunction <span class="property">@_currentWorker</span>
					<span class="property">@trigger</span>(<span class="string">'step'</span>, <span class="property">@shared</span>, <span class="property">@_currentWorker</span>)
					cNext = _.bind(<span class="property">@_next</span>, <span class="keyword">this</span>)
					<span class="property">@_currentWorker</span>(<span class="property">@shared</span>, cNext)

				<span class="keyword">else</span>
					<span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">"The <span class="subst">#{@_currentWorker.id}</span> cannot be executed"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>fire the <strong>complete</strong> event if the queue have been succesfully runned</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>TODO: set the app as notBusy</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="property">@trigger</span>(<span class="string">'complete'</span>, <span class="property">@shared</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>enable events for the Flow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_.extend(Flow.prototype, Backbone.Events)</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2>Worker</h2>
<p>define the Worker </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Worker = <span class="class"><span class="keyword">class</span> <span class="title">PantaRhei</span>.<span class="title">Worker</span></span>

	constructor: (<span class="property">@id</span> = _.uniqueId(<span class="string">'worker_'</span>)) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h3>Methods</h3>
<h4>run</h4>
<p>Used by the flow to execute the worker.
It&#39;s meant to be overridden, if not it will pass an error to the flow
It accept the following mandatory arguments:</p>
<ul>
<li><strong>shared</strong> object, which purpose is to act as a vehicle of data among the various worker;</li>
<li><strong>next</strong> to call next step of the flow</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	run: (<span class="property">@shared</span>, <span class="property">@next</span>) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>run the next worker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="property">@next</span>(<span class="keyword">new</span> Error(<span class="string">'run must be overridden'</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h4>kill</h4>
<p>This is runned by the Flow before running the next worker
It&#39;s meant to be overridden, if not it will throw an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	kill: -&gt;
		<span class="keyword">throw</span> <span class="keyword">new</span> ReferenceError <span class="string">"kill must be overridden "</span>

_.extend(Worker.prototype, Backbone.Events)</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Borrowed the Backbone style extend</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Flow.extend = Worker.extend = Backbone.View.extend</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
